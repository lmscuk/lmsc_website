{% extends 'admin/base_admin.html' %}

{% block nav_title %}All Leads{% endblock %}
{% block title %}Lead Records · LMSC Admin{% endblock %}

{% block extra_head %}
  <link
    rel="stylesheet"
    href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css"
  />
{% endblock %}

{% block extra_scripts %}
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const table = $('#lead-table').DataTable({
        pageLength: 25,
        order: [[6, 'desc']],
        responsive: false,
      });

      const statusFilter = document.getElementById('statusFilter');
      if (statusFilter) {
        statusFilter.addEventListener('change', (event) => {
          const value = event.target.value;
          table.column(4).search(value ? `^${value}$` : '', true, false).draw();
        });
      }
    });
  </script>
{% endblock %}

{% block content %}
  <header class="mb-8">
    <h1 class="text-3xl font-bold text-slate-900">Lead Records</h1>
    <p class="text-sm text-slate-500 mt-1">Review every enquiry, update statuses, and keep the admissions pipeline organised.</p>
  </header>

  <section class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4 mb-8">
    {% for status in statuses %}
      <article class="bg-white rounded-3xl shadow-sm border border-slate-100 p-5">
        <p class="text-xs uppercase tracking-widest text-slate-400">{{ status }}</p>
        <p class="text-2xl font-bold text-slate-900 mt-3">{{ status_counts.get(status, 0) }}</p>
      </article>
    {% endfor %}
  </section>

  <section class="bg-white rounded-3xl shadow-sm border border-slate-100 p-6">
    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between mb-6">
      <div>
        <h2 class="text-xl font-semibold text-slate-900">All Leads</h2>
        <p class="text-sm text-slate-500">Search, sort, and filter the admissions pipeline in one place.</p>
      </div>
      <div class="flex items-center gap-3">
        <label for="statusFilter" class="text-xs uppercase tracking-widest text-slate-400">Status</label>
        <select
          id="statusFilter"
          class="rounded-full border border-slate-200 bg-white px-4 py-2 text-sm focus:border-primary focus:outline-none"
        >
          <option value="">Show all</option>
          {% for status in statuses %}
            <option value="{{ status }}">{{ status }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
    <div class="overflow-x-auto">
      <table id="lead-table" class="min-w-full text-sm display">
        <thead class="bg-slate-50 text-xs uppercase tracking-widest text-slate-500">
          <tr>
            <th class="px-4 py-3 text-left">Name</th>
            <th class="px-4 py-3 text-left">Email</th>
            <th class="px-4 py-3 text-left">Phone</th>
            <th class="px-4 py-3 text-left">Type</th>
            <th class="px-4 py-3 text-left">Status</th>
            <th class="px-4 py-3 text-left">Update</th>
            <th class="px-4 py-3 text-left">Created</th>
            <th class="px-4 py-3 text-left">Updated</th>
            <th class="px-4 py-3 text-left">Message</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-200">
          {% for lead in leads %}
            <tr>
              <td class="px-4 py-3 font-medium text-slate-900">{{ lead['full_name'] or '—' }}</td>
              <td class="px-4 py-3">
                {% if lead['email'] %}
                  <a href="mailto:{{ lead['email'] }}" class="text-primary font-semibold">{{ lead['email'] }}</a>
                {% else %}
                  <span class="text-slate-400">—</span>
                {% endif %}
              </td>
              <td class="px-4 py-3">{{ lead['phone'] or '—' }}</td>
              <td class="px-4 py-3 capitalize">{{ lead['lead_type'] }}</td>
              <td class="px-4 py-3">{{ lead['status'] }}</td>
              <td class="px-4 py-3">
                <form
                  method="post"
                  action="{{ url_for('update_lead_status', lead_id=lead['id']) }}"
                  class="flex items-center gap-2"
                >
                  <select
                    name="status"
                    class="rounded-full border border-slate-200 bg-white px-3 py-1 text-xs focus:border-primary focus:outline-none"
                  >
                    {% for status in statuses %}
                      <option value="{{ status }}" {% if lead['status'] == status %}selected{% endif %}>{{ status }}</option>
                    {% endfor %}
                  </select>
                  <button
                    type="submit"
                    class="inline-flex items-center rounded-full border border-primary px-3 py-1 text-xs font-semibold text-primary hover:bg-primary hover:text-white transition"
                  >
                    Save
                  </button>
                </form>
              </td>
              <td class="px-4 py-3 text-slate-500" data-order="{{ lead['created_at'] }}">{{ lead['created_at'] }}</td>
              <td class="px-4 py-3 text-slate-500" data-order="{{ lead['updated_at'] }}">{{ lead['updated_at'] }}</td>
              <td class="px-4 py-3 text-slate-500">{{ lead['message'] or '—' }}</td>
            </tr>
          {% else %}
            <tr>
              <td colspan="9" class="px-4 py-6 text-center text-slate-500">No leads captured yet.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
{% endblock %}
