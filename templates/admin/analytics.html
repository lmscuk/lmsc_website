{% extends 'admin/base_admin.html' %}

{% block nav_title %}Site Analytics{% endblock %}
{% block title %}Site Analytics · LMSC Admin{% endblock %}
{% block meta_description %}
<meta
  name="description"
  content="Monitor traffic, content performance and lead trends within the LMSC admin analytics dashboard."
/>
{% endblock %}

{% block extra_head %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
{% macro format_value(card) -%}
  {%- if card.format == 'number' -%}
    {{ '{:,.0f}'.format(card.value) }}
  {%- elif card.format == 'percent' -%}
    {{ '{:.1f}%'.format(card.value) }}
  {%- else -%}
    {{ '{:.2f}'.format(card.value) }}
  {%- endif -%}
{%- endmacro %}

{% macro format_change(change) -%}
  {%- if change is none -%}
    —
  {%- else -%}
    {{ '{:+.1f}%'.format(change) }}
  {%- endif -%}
{%- endmacro %}

<header class="mb-10 flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
  <div>
    <h1 class="text-3xl font-bold text-slate-900">Site Analytics</h1>
    <p class="mt-2 max-w-2xl text-sm text-slate-500">
      Monitor visitor engagement, top content, and acquisition trends. {{ range_label }} summarised {{ comparison_label }}.
    </p>
  </div>
  <form method="get" class="flex items-center gap-3">
    <label for="range" class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">Date Range</label>
    <select
      id="range"
      name="range"
      class="rounded-full border border-slate-200 bg-white px-4 py-2 text-sm font-medium text-slate-700 shadow-sm focus:border-primary focus:outline-none"
      onchange="this.form.submit()"
    >
      {% for option in range_options %}
        <option value="{{ option }}" {% if option == range_days %}selected{% endif %}>Last {{ option }} days</option>
      {% endfor %}
    </select>
  </form>
</header>

{% if page_views == 0 %}
  <div class="mb-8 rounded-3xl border border-dashed border-slate-200 bg-slate-50 p-6 text-sm text-slate-600">
    <p class="font-semibold text-slate-800">No analytics data yet</p>
    <p class="mt-2">Events will appear here after visitors browse pages that load the tracking beacon. Confirm the public site is using the latest deployment and revisit in a little while.</p>
  </div>
{% endif %}

<section class="grid gap-4 md:grid-cols-2 xl:grid-cols-4">
  {% for card in kpi_cards %}
    {% set direction = card.trend_direction or 'neutral' %}
    {% set badge_classes = 'border border-slate-200 bg-slate-100 text-slate-600' %}
    {% if direction == 'up' %}
      {% set badge_classes = 'border border-emerald-100 bg-emerald-50 text-emerald-700' %}
    {% elif direction == 'down' %}
      {% set badge_classes = 'border border-rose-100 bg-rose-50 text-rose-600' %}
    {% endif %}
    <article class="rounded-3xl border border-slate-100 bg-white p-6 shadow-sm">
      <p class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">{{ card.label }}</p>
      <div class="mt-3 flex items-end justify-between">
        <p class="text-3xl font-bold text-slate-900">{{ format_value(card) }}</p>
        <span class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold {{ badge_classes }}">
          {% if card.trend_direction == 'up' %}
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-3.5 w-3.5">
              <path d="M5 15l7-7 7 7" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          {% elif card.trend_direction == 'down' %}
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-3.5 w-3.5">
              <path d="M19 9l-7 7-7-7" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          {% else %}
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-3.5 w-3.5">
              <path d="M5 12h14" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          {% endif %}
          <span>{{ format_change(card.trend) }}</span>
        </span>
      </div>
      <p class="mt-2 text-xs text-slate-500">{{ card.caption }}</p>
      {% if card.supplement %}
        <p class="mt-3 text-xs font-semibold text-slate-400">{{ card.supplement }}</p>
      {% endif %}
    </article>
  {% endfor %}
</section>

<section class="mt-10 grid gap-6 xl:grid-cols-3">
  <article class="rounded-3xl border border-slate-100 bg-white p-6 shadow-sm xl:col-span-2">
    <div class="flex items-center justify-between">
      <h2 class="text-lg font-semibold text-slate-900">Daily performance</h2>
      <p class="text-xs font-medium uppercase tracking-[0.2em] text-slate-400">{{ range_label }}</p>
    </div>
    <canvas id="dailyChart" class="mt-6 h-72"></canvas>
  </article>
  <article class="rounded-3xl border border-slate-100 bg-white p-6 shadow-sm">
    <h2 class="text-lg font-semibold text-slate-900">Visitor mix &amp; conversions</h2>
    {% set returning_rate = 100 - new_visitor_rate %}
    <div class="mt-6 space-y-5">
      <div>
        <div class="flex items-center justify-between text-xs font-semibold text-slate-500">
          <span>New visitors</span>
          <span>{{ '{:,.0f}'.format(new_visitors) }}</span>
        </div>
        <div class="mt-2 h-2 rounded-full bg-slate-100">
          <div class="h-2 rounded-full bg-primary" style="width: {{ new_visitor_rate }}%;"></div>
        </div>
      </div>
      <div>
        <div class="flex items-center justify-between text-xs font-semibold text-slate-500">
          <span>Returning visitors</span>
          <span>{{ '{:,.0f}'.format(returning_visitors) }}</span>
        </div>
        <div class="mt-2 h-2 rounded-full bg-slate-100">
          <div class="h-2 rounded-full bg-secondary" style="width: {{ returning_rate }}%;"></div>
        </div>
      </div>
    </div>
    <dl class="mt-6 grid gap-4 text-sm text-slate-600">
      <div class="flex items-center justify-between">
        <dt>Leads captured</dt>
        <dd class="font-semibold text-slate-900">{{ '{:,.0f}'.format(lead_count) }}</dd>
      </div>
      <div class="flex items-center justify-between">
        <dt>Conversion rate</dt>
        <dd class="font-semibold text-slate-900">{{ '{:.1f}%'.format(conversion_rate) }}</dd>
      </div>
      <div class="flex items-center justify-between">
        <dt>Average pages / session</dt>
        <dd class="font-semibold text-slate-900">{{ '{:.2f}'.format(avg_pages_per_session) }}</dd>
      </div>
      <div class="flex items-center justify-between">
        <dt>Bounce rate</dt>
        <dd class="font-semibold text-slate-900">{{ '{:.1f}%'.format(bounce_rate) }}</dd>
      </div>
    </dl>
  </article>
</section>

<section class="mt-8 grid gap-6 lg:grid-cols-3">
  <article class="rounded-3xl border border-slate-100 bg-white p-6 shadow-sm">
    <h2 class="text-lg font-semibold text-slate-900">Hourly engagement</h2>
    <canvas id="hourlyChart" class="mt-6 h-64"></canvas>
  </article>
  <article class="rounded-3xl border border-slate-100 bg-white p-6 shadow-sm">
    <h2 class="text-lg font-semibold text-slate-900">Devices</h2>
    <canvas id="deviceChart" class="mt-6 h-56"></canvas>
    <ul class="mt-6 space-y-3 text-sm text-slate-600">
      {% for row in device_table %}
        <li class="flex items-center justify-between">
          <span>{{ row.device_type }}</span>
          <span class="font-semibold text-slate-900">{{ '{:,.0f}'.format(row.visits) }} <span class="text-xs text-slate-400">({{ '{:.1f}%'.format(row.share) }})</span></span>
        </li>
      {% endfor %}
    </ul>
    {% if os_table %}
      <hr class="my-5 border-slate-100" />
      <h3 class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">Operating systems</h3>
      <ul class="mt-3 space-y-2 text-sm text-slate-600">
        {% for row in os_table %}
          <li class="flex items-center justify-between">
            <span>{{ row.device_os }}</span>
            <span class="font-semibold text-slate-900">{{ '{:,.0f}'.format(row.visits) }} ({{ '{:.1f}%'.format(row.share) }})</span>
          </li>
        {% endfor %}
      </ul>
    {% endif %}
  </article>
  <article class="rounded-3xl border border-slate-100 bg-white p-6 shadow-sm">
    <h2 class="text-lg font-semibold text-slate-900">Traffic sources</h2>
    <canvas id="trafficChart" class="mt-6 h-56"></canvas>
    <ul class="mt-6 space-y-3 text-sm text-slate-600">
      {% for row in traffic_table %}
        <li class="flex items-center justify-between">
          <span>{{ row.source }}</span>
          <span class="font-semibold text-slate-900">{{ '{:,.0f}'.format(row.visits) }} <span class="text-xs text-slate-400">({{ '{:.1f}%'.format(row.share) }})</span></span>
        </li>
      {% endfor %}
    </ul>
  </article>
</section>

<section class="mt-8 grid gap-6 xl:grid-cols-3">
  <article class="rounded-3xl border border-slate-100 bg-white p-6 shadow-sm xl:col-span-2">
    <h2 class="text-lg font-semibold text-slate-900">Top locations</h2>
    <canvas id="countryChart" class="mt-6 h-72"></canvas>
    <ul class="mt-6 space-y-3 text-sm text-slate-600">
      {% for row in top_countries[:6] %}
        <li>
          <div class="flex items-center justify-between">
            <span class="font-semibold text-slate-800">{{ row.country }}</span>
            <span class="text-sm font-semibold text-slate-900">{{ '{:,.0f}'.format(row.visits) }} <span class="text-xs text-slate-400">({{ '{:.1f}%'.format(row.share) }})</span></span>
          </div>
          <div class="mt-2 h-2 rounded-full bg-slate-100">
            <div class="h-2 rounded-full bg-secondary" style="width: {{ row.share }}%;"></div>
          </div>
        </li>
      {% endfor %}
    </ul>
  </article>
  <article class="rounded-3xl border border-slate-100 bg-white p-6 shadow-sm">
    <h2 class="text-lg font-semibold text-slate-900">Timezones</h2>
    <ul class="mt-4 space-y-3 text-sm text-slate-600">
      {% for row in timezone_table %}
        <li class="flex items-center justify-between">
          <span>{{ row.timezone }}</span>
          <span class="font-semibold text-slate-900">{{ '{:,.0f}'.format(row.visits) }}</span>
        </li>
      {% endfor %}
    </ul>
    <hr class="my-6 border-slate-100" />
    <h2 class="text-lg font-semibold text-slate-900">Engagement totals</h2>
    <dl class="mt-4 space-y-3 text-sm text-slate-600">
      <div class="flex items-center justify-between">
        <dt>Page views</dt>
        <dd class="font-semibold text-slate-900">{{ '{:,.0f}'.format(page_views) }}</dd>
      </div>
      <div class="flex items-center justify-between">
        <dt>Sessions</dt>
        <dd class="font-semibold text-slate-900">{{ '{:,.0f}'.format(sessions_total) }}</dd>
      </div>
      <div class="flex items-center justify-between">
        <dt>Unique visitors</dt>
        <dd class="font-semibold text-slate-900">{{ '{:,.0f}'.format(unique_visitors) }}</dd>
      </div>
    </dl>
  </article>
</section>

<section class="mt-8 grid gap-6 xl:grid-cols-2">
  <article class="rounded-3xl border border-slate-100 bg-white p-6 shadow-sm">
    <div class="flex items-center justify-between">
      <h2 class="text-lg font-semibold text-slate-900">Popular pages</h2>
      <span class="text-xs font-medium text-slate-400">Page views {{ '{:,.0f}'.format(page_views) }}</span>
    </div>
    <div class="mt-4 overflow-x-auto">
      <table class="min-w-full divide-y divide-slate-200 text-sm">
        <thead class="bg-slate-50 text-xs uppercase tracking-[0.2em] text-slate-400">
          <tr>
            <th class="px-4 py-3 text-left">Page</th>
            <th class="px-4 py-3 text-right">Views</th>
            <th class="px-4 py-3 text-right">Sessions</th>
            <th class="px-4 py-3 text-right">Share</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100 text-slate-600">
          {% for page in top_pages %}
            <tr class="hover:bg-slate-50">
              <td class="px-4 py-3">
                <div class="flex flex-col">
                  {% if page.url and page.url != '#' %}
                    <a
                      href="{{ page.url }}"
                      class="font-semibold text-slate-900 hover:text-primary"
                      target="_blank"
                      rel="noopener"
                    >
                      {{ page.title }}
                    </a>
                  {% else %}
                    <span class="font-semibold text-slate-900">{{ page.title }}</span>
                  {% endif %}
                  {% if page.slug %}
                    <span class="text-xs text-slate-400">/{{ page.slug }}</span>
                  {% endif %}
                </div>
              </td>
              <td class="px-4 py-3 text-right font-semibold text-slate-900">{{ '{:,.0f}'.format(page.views) }}</td>
              <td class="px-4 py-3 text-right">{{ '{:,.0f}'.format(page.sessions) }}</td>
              <td class="px-4 py-3 text-right">{{ '{:.1f}%'.format(page.share) }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </article>
  <article class="rounded-3xl border border-slate-100 bg-white p-6 shadow-sm">
    <h2 class="text-lg font-semibold text-slate-900">Top referral sources</h2>
    <div class="mt-4 overflow-x-auto">
      <table class="min-w-full divide-y divide-slate-200 text-sm">
        <thead class="bg-slate-50 text-xs uppercase tracking-[0.2em] text-slate-400">
          <tr>
            <th class="px-4 py-3 text-left">Domain</th>
            <th class="px-4 py-3 text-right">Visits</th>
            <th class="px-4 py-3 text-right">Channel</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100 text-slate-600">
          {% for ref in referrer_table %}
            <tr class="hover:bg-slate-50">
              <td class="px-4 py-3 font-semibold text-slate-900">{{ ref.domain }}</td>
              <td class="px-4 py-3 text-right">{{ '{:,.0f}'.format(ref.visits) }}</td>
              <td class="px-4 py-3 text-right text-xs uppercase tracking-[0.2em] text-slate-400">{{ ref.source }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </article>
</section>
{% endblock %}

{% block extra_scripts %}
  <script>
    (function () {
      if (typeof Chart === 'undefined') {
        return;
      }
      Chart.defaults.font.family = 'Montserrat, sans-serif';
      const palette = ['#387951', '#16A7A0', '#C5F3C5', '#1F2937', '#F97316', '#6366F1'];
      const dailyData = {{ daily_chart | tojson }};
      const hourlyData = {{ hourly_chart | tojson }};
      const deviceData = {{ device_chart | tojson }};
      const trafficData = {{ traffic_chart | tojson }};
      const countryData = {{ country_chart | tojson }};

      const createGradient = (ctx, color) => {
        const gradient = ctx.createLinearGradient(0, 0, 0, 280);
        gradient.addColorStop(0, color);
        gradient.addColorStop(1, 'rgba(255,255,255,0)');
        return gradient;
      };

      const dailyCtx = document.getElementById('dailyChart');
      if (dailyCtx && dailyData.labels && dailyData.labels.length) {
        const viewGradient = createGradient(dailyCtx.getContext('2d'), 'rgba(56,121,81,0.25)');
        new Chart(dailyCtx, {
          type: 'line',
          data: {
            labels: dailyData.labels,
            datasets: [
              {
                label: 'Page Views',
                data: dailyData.page_views,
                borderColor: '#387951',
                backgroundColor: viewGradient,
                tension: 0.35,
                fill: true,
                borderWidth: 2,
              },
              {
                label: 'Sessions',
                data: dailyData.sessions,
                borderColor: '#16A7A0',
                backgroundColor: 'rgba(22,167,160,0.12)',
                tension: 0.35,
                fill: false,
                borderWidth: 2,
                borderDash: [6, 4],
              },
              {
                label: 'Unique Visitors',
                data: dailyData.unique,
                borderColor: '#1F2937',
                backgroundColor: 'rgba(31,41,55,0.08)',
                tension: 0.35,
                fill: false,
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'bottom',
                labels: { usePointStyle: true },
              },
              tooltip: {
                mode: 'index',
                intersect: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(148,163,184,0.25)' },
                ticks: { color: '#475569' },
              },
              x: {
                grid: { display: false },
                ticks: { color: '#64748b' },
              },
            },
          },
        });
      }

      const hourlyCtx = document.getElementById('hourlyChart');
      if (hourlyCtx && hourlyData.labels && hourlyData.labels.length) {
        new Chart(hourlyCtx, {
          type: 'bar',
          data: {
            labels: hourlyData.labels,
            datasets: [
              {
                label: 'Visits',
                data: hourlyData.values,
                backgroundColor: '#387951',
                borderRadius: 6,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(148,163,184,0.25)' },
                ticks: { color: '#475569' },
              },
              x: {
                grid: { display: false },
                ticks: { color: '#64748b', maxRotation: 0, minRotation: 0 },
              },
            },
          },
        });
      }

      const deviceCtx = document.getElementById('deviceChart');
      if (deviceCtx && deviceData.labels && deviceData.labels.length) {
        new Chart(deviceCtx, {
          type: 'doughnut',
          data: {
            labels: deviceData.labels,
            datasets: [
              {
                data: deviceData.values,
                backgroundColor: palette,
                borderWidth: 1,
                borderColor: '#ffffff',
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
              legend: {
                position: 'bottom',
                labels: { usePointStyle: true },
              },
            },
          },
        });
      }

      const trafficCtx = document.getElementById('trafficChart');
      if (trafficCtx && trafficData.labels && trafficData.labels.length) {
        new Chart(trafficCtx, {
          type: 'doughnut',
          data: {
            labels: trafficData.labels,
            datasets: [
              {
                data: trafficData.values,
                backgroundColor: palette,
                borderWidth: 1,
                borderColor: '#ffffff',
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
              legend: {
                position: 'bottom',
                labels: { usePointStyle: true },
              },
            },
          },
        });
      }

      const countryCtx = document.getElementById('countryChart');
      if (countryCtx && countryData.labels && countryData.labels.length) {
        new Chart(countryCtx, {
          type: 'bar',
          data: {
            labels: countryData.labels,
            datasets: [
              {
                label: 'Visits',
                data: countryData.values,
                backgroundColor: '#16A7A0',
                borderRadius: 6,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
              legend: { display: false },
            },
            scales: {
              x: {
                beginAtZero: true,
                grid: { color: 'rgba(148,163,184,0.25)' },
                ticks: { color: '#475569' },
              },
              y: {
                grid: { display: false },
                ticks: { color: '#64748b' },
              },
            },
          },
        });
      }
    })();
  </script>
{% endblock %}
